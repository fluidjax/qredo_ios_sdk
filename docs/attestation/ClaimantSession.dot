digraph ClaimantSession {
  rankdir="LR"
 
  start -> requestingPresentation 
 
  requestingPresentation -> cancel [label = "publishMessageHandler(error)\n[error != nil]"]
  requestingPresentation -> cancelledByOtherSide [label="conversationMessageReceived(msg)\n[msg == cancel]"]
  requestingPresentation -> waitingForPresentations [label = "publishMessageHandler(error)\n[error == nil]"]
  requestingPresentation -> cancel [label="vendorDidCancel()"]

  waitingForPresentations -> cancelledByOtherSide [label="conversationMessageReceived(msg)\n[msg == cancel]"]
  waitingForPresentations -> receivedPresentations [label="conversationMessageReceived(msg)\n[msg == presentations]"]
  waitingForPresentations -> cancel [label="vendorDidCancel()"]

  receivedPresentations -> receivedAuthenticationResults [label="authenticationComplete(results)"]
  receivedPresentations -> cancel [label="authenticationCompleteWithError(error)"]
  receivedPresentations -> cancelledByOtherSide [label="conversationMessageReceived(msg)\n[msg == cancel]"]

  receivedAuthenticationResults -> sendAttestationResult [label="vendorDidChooseResult(result)"]
  receivedAuthenticationResults -> cancel [label="vendorDidCancel()"]
  receivedAuthenticationResults -> cancelledByOtherSide [label="conversationMessageReceived(msg)\n[msg == cancel]"]

  sendAttestationResult -> cancel [label="sendVendorChoiceCompletionHandler(error)\n[error != nil]"]
  sendAttestationResult -> finish [label="sendVendorChoiceCompletionHandler(error)\n[error == nil]"]

  cancel -> finish [label = "cancelConversationHander(error)"]

  cancelledByOtherSide -> finish [label = "vendorDidPressOK()"]

# Labels for the states
  start [label="Start", style=filled, fillcolor=green]
  requestingPresentation [label = "Requesting Presentations\nEnter: publishMessage(presentationRequest)", shape=box, style="filled,rounded", fillcolor=palegreen]
  waitingForPresentations [label = "Waiting for Presentations\n(Accept/Reject UI)\nEnter: updateUI()", shape=box, style="filled,rounded", fillcolor=palegreen]
  cancelledByOtherSide [label = "Cancelled by Alice\nEnter: updateUI()", shape=box, style="filled,rounded", fillcolor=red]
  receivedPresentations [label = "Received Presentations\n(Accept/Reject UI)\nEnter: updateUI(presentations); authenticatePresentations()", shape=box, style="filled,rounded", fillcolor=palegreen]
  receivedAuthenticationResults [label = "Received Authentication results\n(Accept/Reject UI)\nEnter: updateUI(authentications)", shape=box, style="filled,rounded", fillcolor=palegreen]
  sendAttestationResult [label = "Send vendor choice\nEnter: sendVendorChoice(attestationResult)", shape=box, style="filled,rounded", fillcolor=palegreen]
  cancel [label = "Cancel conversation\ncancelConversation(error)", shape=box, style="filled,rounded"]
  finish [label = "Finish\nEnter: nupdateUI()", style=filled, fillcolor=palegreen]
}
